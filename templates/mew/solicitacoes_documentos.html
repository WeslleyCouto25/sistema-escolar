<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>MEW - Solicita√ß√µes de Documentos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="topbar">
        <div class="navbar-header">
            <div class="logo-text">MEW - Painel Administrativo</div>
        </div>
        <div class="spacer"></div>
        <div class="user-menu">
            <a href="/mew/dashboard" class="logout-btn">Dashboard</a>
            <a href="/" class="logout-btn">Site Principal</a>
        </div>
    </div>

    <div class="main-container">
        <nav class="sidebar">
            <div class="user-profile">
                <div class="profile-img">
                    <i class="fas fa-user-cog"></i>
                </div>
                <div class="profile-text">
                    <div class="name">Administrador</div>
                    <div class="ra">MEW Admin</div>
                </div>
            </div>
            
            <div class="main-menu">
                <a href="/mew/dashboard" class="menu-item">
                    <i class="fas fa-home"></i>
                    <span class="text">Dashboard</span>
                </a>
                <a href="/mew/disciplinas" class="menu-item">
                    <i class="fas fa-book"></i>
                    <span class="text">Disciplinas</span>
                </a>
                <a href="/mew/alunos" class="menu-item">
                    <i class="fas fa-users"></i>
                    <span class="text">Alunos</span>
                </a>
                <a href="/mew/solicitacoes" class="menu-item">
                    <i class="fas fa-file-alt"></i>
                    <span class="text">Materiais/Decl.</span>
                </a>
                <a href="/mew/solicitacoes-documentos" class="menu-item active">
                    <i class="fas fa-file-contract"></i>
                    <span class="text">Documentos</span>
                    {% set doc_pendentes = solicitacoes|selectattr('status', 'equalto', 'pendente')|list|length %}
                    {% if doc_pendentes > 0 %}
                    <span class="badge">{{ doc_pendentes }}</span>
                    {% endif %}
                </a>
            </div>
        </nav>

        <main class="content-area">
            <h1 class="page-title">üìÑ Solicita√ß√µes de Documentos</h1>

            <div class="mew-card">
                {% if solicitacoes %}
                <table class="requests-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Aluno</th>
                            <th>Tipo</th>
                            <th>Disciplinas</th>
                            <th>Detalhes</th>
                            <th>Data</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in solicitacoes %}
                        <tr>
                            <td>{{ s['id'] }}</td>
                            <td>
                                <div>{{ s['aluno_nome'] }}</div>
                                <small style="color: var(--medium-gray);">{{ s['aluno_email'] }}</small>
                            </td>
                            <td>
                                {% if s['tipo_documento'] == 'conclusao' %}
                                Conclus√£o
                                {% elif s['tipo_documento'] == 'plano_ensino' %}
                                Plano de Ensino
                                {% elif s['tipo_documento'] == 'historico' %}
                                Hist√≥rico
                                {% elif s['tipo_documento'] == 'sugestao' %}
                                Feedback
                                {% else %}
                                Outros
                                {% endif %}
                            </td>
                            <td>{{ s['disciplinas_nomes'] or 'N/A' }}</td>
                            <td>{{ s['detalhes'][:50] }}{% if s['detalhes']|length > 50 %}...{% endif %}</td>
                            <td>{{ s['data_solicitacao'] }}</td>
                            <td>
                                {% if s['status'] == 'pendente' %}
                                <span class="status-indicator status-pending-approval">Pendente</span>
                                {% elif s['status'] == 'processando' %}
                                <span class="status-indicator status-processing">Processando</span>
                                {% elif s['status'] == 'concluido' %}
                                <span class="status-indicator status-delivered">Conclu√≠do</span>
                                {% endif %}
                            </td>
                            <td style="display: flex; gap: 5px;">
                                <button onclick="abrirModalResposta({{ s['id'] }}, '{{ s['tipo_documento'] }}')" 
                                        class="btn btn-primary" style="padding: 5px 10px; font-size: 13px;">
                                    <i class="fas fa-reply"></i> Responder
                                </button>
                                <a href="/mew/deletar-solicitacao-doc/{{ s['id'] }}" 
                                   class="btn btn-secondary" style="padding: 5px 10px; font-size: 13px;"
                                   onclick="return confirm('Tem certeza que deseja excluir esta solicita√ß√£o?')">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-file-contract"></i>
                    <h3>Nenhuma solicita√ß√£o de documento</h3>
                    <p>N√£o h√° solicita√ß√µes de documentos pendentes.</p>
                </div>
                {% endif %}
            </div>
        </main>
    </div>

    <!-- Modal de Resposta -->
    <div id="modalResposta" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: white; margin: 10% auto; padding: 20px; border-radius: 10px; width: 80%; max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="modalRespostaTitulo">Responder Solicita√ß√£o</h3>
                <button onclick="fecharModalResposta()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            
            <input type="hidden" id="docId">
            
            <div class="form-group">
                <label>Status</label>
                <select class="form-control" id="docStatus">
                    <option value="pendente">Pendente</option>
                    <option value="processando">Processando</option>
                    <option value="concluido">Conclu√≠do</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Resposta</label>
                <textarea class="form-control" id="docResposta" rows="4" placeholder="Digite sua resposta..."></textarea>
            </div>
            
            <div class="form-group">
                <label>URL do Arquivo (opcional)</label>
                <input type="text" class="form-control" id="docArquivoUrl" placeholder="https://exemplo.com/arquivo.pdf">
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="fecharModalResposta()" class="btn btn-secondary" style="margin-right: 10px;">Cancelar</button>
                <button onclick="enviarResposta()" class="btn btn-primary">Enviar Resposta</button>
            </div>
        </div>
    </div>

    <script>
        function abrirModalResposta(id, tipo) {
            document.getElementById('docId').value = id;
            document.getElementById('modalRespostaTitulo').textContent = `Responder ${getNomeDocumento(tipo)}`;
            document.getElementById('modalResposta').style.display = 'block';
        }
        
        function fecharModalResposta() {
            document.getElementById('modalResposta').style.display = 'none';
            document.getElementById('docResposta').value = '';
            document.getElementById('docArquivoUrl').value = '';
            document.getElementById('docStatus').value = 'concluido';
        }
        
        function enviarResposta() {
            const id = document.getElementById('docId').value;
            const resposta = document.getElementById('docResposta').value;
            const status = document.getElementById('docStatus').value;
            const arquivoUrl = document.getElementById('docArquivoUrl').value;
            
            fetch('/mew/responder-documento/' + id, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    resposta: resposta,
                    status: status,
                    arquivo_url: arquivoUrl
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Resposta enviada com sucesso!');
                    fecharModalResposta();
                    location.reload();
                } else {
                    alert('Erro: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao enviar resposta');
            });
        }
        
        function getNomeDocumento(tipo) {
            const nomes = {
                'conclusao': 'Declara√ß√£o de Conclus√£o',
                'plano_ensino': 'Plano de Ensino',
                'historico': 'Hist√≥rico Escolar',
                'sugestao': 'Feedback/Sugest√£o',
                'outros': 'Outros Documentos'
            };
            return nomes[tipo] || tipo;
        }
    </script>
</body>
</html>