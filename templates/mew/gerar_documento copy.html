<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>MEW - Gerar Documento Autenticado</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        .editor-container {
            height: 300px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .template-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .template-btn {
            padding: 8px 15px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .template-btn:hover {
            background: #e9ecef;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            flex: 1;
        }
        .preview-area {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
            min-height: 200px;
            border: 1px dashed #ddd;
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="navbar-header">
            <a href="/mew/dashboard" class="back-btn">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
            <div class="logo-text">MEW - Gerar Documento Autenticado</div>
        </div>
        <div class="user-menu">
            <a href="/mew/listar-documentos" class="logout-btn">üìã Listar Documentos</a>
            <a href="/mew/dashboard" class="logout-btn">üè† Dashboard</a>
        </div>
    </div>

    <div class="main-container">
        <main class="content-area" style="max-width: 1000px; margin: 0 auto;">
            <h1 class="page-title">üìÑ Gerar Documento Autenticado</h1>
            <p class="page-subtitle">Gere documentos oficiais com c√≥digo de autentica√ß√£o e valida√ß√£o digital</p>

            <div class="mew-card">
                <form id="documentoForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo de Documento</label>
                            <select class="form-control" id="tipoDocumento" required>
                                <option value="">Selecione...</option>
                                <option value="plano_ensino">Plano de Ensino</option>
                                <option value="historico">Hist√≥rico Escolar</option>
                                <option value="conclusao">Declara√ß√£o de Conclus√£o</option>
                                <option value="matricula">Declara√ß√£o de Matr√≠cula</option>
                                <option value="outros">Outro Documento</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Aluno</label>
                            <select class="form-control" id="alunoId" required>
                                <option value="">Selecione um aluno...</option>
                                {% for aluno in alunos %}
                                <option value="{{ aluno.id }}">{{ aluno.nome }} (RA: {{ aluno.ra }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Disciplina (opcional)</label>
                            <select class="form-control" id="disciplinaId">
                                <option value="0">N√£o especificar</option>
                                {% for disciplina in disciplinas %}
                                <option value="{{ disciplina.id }}">{{ disciplina.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Carga Hor√°ria</label>
                            <input type="text" class="form-control" id="horasAula" value="80" placeholder="Ex: 80">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Observa√ß√µes (opcional)</label>
                        <textarea class="form-control" id="observacoes" rows="2" placeholder="Observa√ß√µes adicionais..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Conte√∫do do Documento</label>
                        <div class="template-buttons">
                            <button type="button" class="template-btn" onclick="carregarTemplate('plano')">
                                üìã Plano de Ensino
                            </button>
                            <button type="button" class="template-btn" onclick="carregarTemplate('historico')">
                                üìä Hist√≥rico Escolar
                            </button>
                            <button type="button" class="template-btn" onclick="carregarTemplate('conclusao')">
                                üéì Declara√ß√£o de Conclus√£o
                            </button>
                            <button type="button" class="template-btn" onclick="carregarTemplate('matricula')">
                                üìù Declara√ß√£o de Matr√≠cula
                            </button>
                        </div>
                        
                        <div id="editor" class="editor-container"></div>
                        <textarea id="conteudoHtml" style="display: none;"></textarea>
                    </div>

                    <div class="form-group">
                        <button type="button" onclick="previewDocumento()" class="btn btn-secondary">
                            <i class="fas fa-eye"></i> Pr√©-visualizar
                        </button>
                        <button type="button" onclick="gerarDocumento()" class="btn btn-primary" style="float: right;">
                            <i class="fas fa-file-signature"></i> Gerar Documento Autenticado
                        </button>
                    </div>
                </form>

                <div id="previewArea" class="preview-area" style="display: none;">
                    <h4>Pr√©-visualiza√ß√£o</h4>
                    <div id="previewContent"></div>
                </div>

                <div id="resultado" style="display: none; margin-top: 20px;"></div>
            </div>

            <div class="mew-card" style="margin-top: 30px;">
                <h3><i class="fas fa-info-circle"></i> Informa√ß√µes</h3>
                <p>Os documentos gerados incluem:</p>
                <ul>
                    <li>P√°gina de autentica√ß√£o com c√≥digo √∫nico</li>
                    <li>Hash SHA-256 para verifica√ß√£o de integridade</li>
                    <li>Validade de 1 ano a partir da emiss√£o</li>
                    <li>C√≥digo de valida√ß√£o p√∫blica</li>
                    <li>Assinatura digital do sistema</li>
                </ul>
                <p><strong>URL de valida√ß√£o p√∫blica:</strong> https://seusite.com/validar-documento/CODIGO</p>
            </div>
        </main>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script>
        // Inicializar editor Quill
        var quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['link', 'image'],
                    ['clean']
                ]
            }
        });

        // Atualizar textarea oculto com conte√∫do HTML
        quill.on('text-change', function() {
            document.getElementById('conteudoHtml').value = quill.root.innerHTML;
        });

        function carregarTemplate(tipo) {
            let conteudo = '';
            
            switch(tipo) {
                case 'plano':
                    conteudo = `
<h2>Plano de Ensino</h2>
<h3>1. IDENTIFICA√á√ÉO DA DISCIPLINA</h3>
<p><strong>Nome da Disciplina:</strong> [NOME DA DISCIPLINA]</p>
<p><strong>C√≥digo:</strong> [C√ìDIGO]</p>
<p><strong>Carga Hor√°ria:</strong> [HORAS] horas</p>

<h3>2. EMENTA</h3>
<p>[DESCRI√á√ÉO DA EMENTA DA DISCIPLINA]</p>

<h3>3. OBJETIVOS</h3>
<h4>3.1 Objetivo Geral</h4>
<p>Proporcionar ao aluno conhecimentos sobre...</p>

<h4>3.2 Objetivos Espec√≠ficos</h4>
<ul>
<li>Compreender os conceitos fundamentais...</li>
<li>Aplicar as t√©cnicas e metodologias...</li>
<li>Desenvolver habilidades pr√°ticas...</li>
</ul>

<h3>4. CONTE√öDO PROGRAM√ÅTICO</h3>
<h4>Unidade 1: Introdu√ß√£o</h4>
<ul>
<li>Conceitos b√°sicos</li>
<li>Hist√≥rico e evolu√ß√£o</li>
<li>Aplica√ß√µes pr√°ticas</li>
</ul>

<h4>Unidade 2: Desenvolvimento</h4>
<ul>
<li>Metodologias avan√ßadas</li>
<li>Estudos de caso</li>
<li>Pr√°ticas laboratoriais</li>
</ul>

<h3>5. METODOLOGIA DE ENSINO</h3>
<p>Aulas expositivas, estudos de caso, trabalhos em grupo, atividades pr√°ticas.</p>

<h3>6. AVALIA√á√ÉO</h3>
<ul>
<li>Provas: 60%</li>
<li>Trabalhos: 30%</li>
<li>Participa√ß√£o: 10%</li>
</ul>

<h3>7. BIBLIOGRAFIA</h3>
<p>1. AUTOR, A. T√≠tulo do Livro. Editora, Ano.</p>
<p>2. AUTOR, B. T√≠tulo do Livro. Editora, Ano.</p>`;
                    break;
                    
                case 'historico':
                    conteudo = `
<h2>HIST√ìRICO ESCOLAR</h2>
<h3>DADOS DO ALUNO</h3>
<table style="width: 100%; border-collapse: collapse;">
<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Nome:</strong></td><td style="padding: 8px; border-bottom: 1px solid #ddd;">[NOME COMPLETO]</td></tr>
<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>RA:</strong></td><td style="padding: 8px; border-bottom: 1px solid #ddd;">[N√öMERO DO RA]</td></tr>
<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Curso:</strong></td><td style="padding: 8px; border-bottom: 1px solid #ddd;">[NOME DO CURSO]</td></tr>
<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Per√≠odo:</strong></td><td style="padding: 8px; border-bottom: 1px solid #ddd;">[PER√çODO]</td></tr>
</table>

<h3>DISCRIMINA√á√ÉO DAS DISCIPLINAS CURSADAS</h3>
<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
<thead>
<tr style="background: #f5f5f5;">
<th style="padding: 10px; text-align: left;">Disciplina</th>
<th style="padding: 10px; text-align: center;">C.H.</th>
<th style="padding: 10px; text-align: center;">Nota</th>
<th style="padding: 10px; text-align: center;">Frequ√™ncia</th>
<th style="padding: 10px; text-align: center;">Situa√ß√£o</th>
</tr>
</thead>
<tbody>
<tr><td style="padding: 10px; border-bottom: 1px solid #ddd;">Disciplina 1</td><td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">80h</td><td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">8,5</td><td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">90%</td><td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">Aprovado</td></tr>
<tr><td style="padding: 10px; border-bottom: 1px solid #ddd;">Disciplina 2</td><td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">60h</td><td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">7,0</td><td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">85%</td><td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">Aprovado</td></tr>
<tr><td style="padding: 10px; border-bottom: 1px solid #ddd;">Disciplina 3</td><td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">40h</td><td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">9,0</td><td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">95%</td><td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">Aprovado</td></tr>
</tbody>
</table>

<h3>RESUMO ACAD√äMICO</h3>
<ul>
<li><strong>M√©dia Geral:</strong> 8,17</li>
<li><strong>Total de Horas Cursadas:</strong> 180 horas</li>
<li><strong>Disciplinas Aprovadas:</strong> 3</li>
<li><strong>√çndice de Aproveitamento:</strong> 91%</li>
</ul>

<h3>OBSERVA√á√ïES</h3>
<p>Documento emitido para fins acad√™micos.</p>`;
                    break;
                    
                case 'conclusao':
                    conteudo = `
<h2>DECLARA√á√ÉO DE CONCLUS√ÉO DE CURSO</h2>

<p style="text-align: justify; line-height: 1.8;">
Declaramos para os devidos fins que <strong>[NOME COMPLETO DO ALUNO]</strong>, 
portador(a) do Registro Acad√™mico n¬∫ <strong>[N√öMERO DO RA]</strong>, 
concluiu satisfatoriamente o curso de <strong>[NOME DO CURSO]</strong>, 
com carga hor√°ria total de <strong>[CARGA HOR√ÅRIA] horas</strong>.
</p>

<p style="text-align: justify; line-height: 1.8;">
O curso foi realizado no per√≠odo de <strong>[DATA IN√çCIO]</strong> a <strong>[DATA T√âRMINO]</strong>, 
com grade curricular composta por disciplinas te√≥ricas e pr√°ticas, conforme regulamento 
interno da institui√ß√£o.
</p>

<p style="text-align: justify; line-height: 1.8;">
O aluno obteve aproveitamento acad√™mico satisfat√≥rio em todas as disciplinas, 
com m√©dia final de <strong>[M√âDIA FINAL]</strong>, demonstrando compet√™ncia e 
dedica√ß√£o durante todo o per√≠odo do curso.
</p>

<h3>INFORMA√á√ïES ADICIONAIS</h3>
<ul>
<li><strong>Modalidade:</strong> [PRESENCIAL/ENSINO A DIST√ÇNCIA]</li>
<li><strong>Coordenador do Curso:</strong> [NOME DO COORDENADOR]</li>
<li><strong>Data da Cola√ß√£o de Grau:</strong> [DATA DA COLACA√á√ÉO]</li>
<li><strong>N√∫mero do Diploma:</strong> [N√öMERO DO DIPLOMA]</li>
<li><strong>Livro:</strong> [N√öMERO DO LIVRO], Folha: [N√öMERO DA FOLHA]</li>
</ul>

<p style="text-align: center; margin-top: 40px;">
Por ser verdade, firmamos a presente declara√ß√£o.
</p>`;
                    break;
                    
                case 'matricula':
                    conteudo = `
<h2>DECLARA√á√ÉO DE MATR√çCULA</h2>

<p style="text-align: justify; line-height: 1.8;">
Declaramos que <strong>[NOME COMPLETO DO ALUNO]</strong>, 
portador(a) do Registro Acad√™mico n¬∫ <strong>[N√öMERO DO RA]</strong>, 
est√° regularmente matriculado(a) no curso de <strong>[NOME DO CURSO]</strong> 
desta institui√ß√£o.
</p>

<p style="text-align: justify; line-height: 1.8;">
A matr√≠cula est√° vigente para o per√≠odo letivo <strong>[ANO/SEMESTRE]</strong>, 
com previs√£o de t√©rmino em <strong>[DATA DE T√âRMINO]</strong>.
</p>

<h3>DETALHES DA MATR√çCULA</h3>
<table style="width: 100%; border-collapse: collapse;">
<tr><td style="padding: 8px; border-bottom: 1px solid #ddd; width: 40%;"><strong>Curso:</strong></td><td style="padding: 8px; border-bottom: 1px solid #ddd;">[NOME DO CURSO]</td></tr>
<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Modalidade:</strong></td><td style="padding: 8px; border-bottom: 1px solid #ddd;">[PRESENCIAL/EAD]</td></tr>
<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Per√≠odo:</strong></td><td style="padding: 8px; border-bottom: 1px solid #ddd;">[MATUTINO/VESPERTINO/NOITE]</td></tr>
<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Carga Hor√°ria Total:</strong></td><td style="padding: 8px; border-bottom: 1px solid #ddd;">[HORAS] horas</td></tr>
<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Data de Ingresso:</strong></td><td style="padding: 8px; border-bottom: 1px solid #ddd;">[DATA DE INGRESSO]</td></tr>
<tr><td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Situa√ß√£o Acad√™mica:</strong></td><td style="padding: 8px; border-bottom: 1px solid #ddd;">[REGULAR/TRANCADO]</td></tr>
</table>

<h3>DISCIPLINAS MATRICULADAS NO PER√çODO ATUAL</h3>
<ul>
<li>Disciplina 1 - [CARGA HOR√ÅRIA] horas</li>
<li>Disciplina 2 - [CARGA HOR√ÅRIA] horas</li>
<li>Disciplina 3 - [CARGA HOR√ÅRIA] horas</li>
</ul>

<p style="text-align: center; margin-top: 40px; font-style: italic;">
Documento v√°lido por 90 dias a partir da data de emiss√£o.
</p>`;
                    break;
            }
            
            quill.root.innerHTML = conteudo;
            document.getElementById('conteudoHtml').value = quill.root.innerHTML;
        }

        function previewDocumento() {
            const conteudo = quill.root.innerHTML;
            if (!conteudo.trim()) {
                alert('Digite algum conte√∫do primeiro!');
                return;
            }
            
            document.getElementById('previewContent').innerHTML = conteudo;
            document.getElementById('previewArea').style.display = 'block';
        }

        function gerarDocumento() {
            const formData = new FormData();
            formData.append('tipo_documento', document.getElementById('tipoDocumento').value);
            formData.append('aluno_id', document.getElementById('alunoId').value);
            formData.append('disciplina_id', document.getElementById('disciplinaId').value);
            formData.append('horas_aula', document.getElementById('horasAula').value);
            formData.append('observacoes', document.getElementById('observacoes').value);
            formData.append('conteudo_html', quill.root.innerHTML);
            
            // Valida√ß√£o b√°sica
            if (!document.getElementById('tipoDocumento').value || !document.getElementById('alunoId').value) {
                alert('Preencha todos os campos obrigat√≥rios!');
                return;
            }
            
            fetch('/mew/gerar-documento-processar', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const html = `
                    <div style="background: #d4edda; color: #155724; padding: 20px; border-radius: 10px; border: 1px solid #c3e6cb;">
                        <h3><i class="fas fa-check-circle"></i> Documento gerado com sucesso!</h3>
                        <p><strong>C√≥digo de Autentica√ß√£o:</strong> ${data.codigo}</p>
                        <p><strong>Hash do Documento:</strong> ${data.hash.substring(0, 50)}...</p>
                        <p><strong>URL de Valida√ß√£o P√∫blica:</strong> <a href="${data.url_validacao}" target="_blank">${data.url_validacao}</a></p>
                        
                        <div style="margin-top: 20px;">
                            <a href="/mew/visualizar-documento/${data.codigo}" target="_blank" class="btn btn-primary">
                                <i class="fas fa-eye"></i> Visualizar Documento
                            </a>
                            <a href="/mew/listar-documentos" class="btn btn-secondary">
                                <i class="fas fa-list"></i> Ver Todos os Documentos
                            </a>
                        </div>
                    </div>`;
                    
                    document.getElementById('resultado').innerHTML = html;
                    document.getElementById('resultado').style.display = 'block';
                    
                    // Rolar para o resultado
                    document.getElementById('resultado').scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Erro: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao gerar documento');
            });
        }
    </script>
</body>
</html>